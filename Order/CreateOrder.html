

<!DOCTYPE html>

<html lang="zh-CN">
<head>
    <title>订单提交</title>
    <meta charset="utf-8">
    <meta content="" name="description">
    <meta content="" name="keywords">
    <meta content="eric.wu" name="author">
    <meta content="application/xhtml+xml;charset=UTF-8" http-equiv="Content-Type">
    <meta content="telephone=no, address=no" name="format-detection">
    <meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
    <link href="../css/reset.css" rel="stylesheet">
    <link href="../css/common.css" rel="stylesheet">
    <link href="../css/order2.css" rel="stylesheet">

    <script>
        var openid = "";
        var stat_webtype = "ordercommit";
        document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
            WeixinJSBridge.call('hideToolbar');
            WeixinJSBridge.call('hideOptionMenu');
        });
        var APP = {
            buyFrom:1,
            page:"ordercreate2",
            message:true,
            goTop:true,
            urls: {
                createOrder_url: "/vshop/Ajax/Post/CreateOrder2",
                wishPay_page: "/vshop/Order/WishDetail",
                balancepay_url:"/vshop/Ajax/Post/MemberPay",
                balancecharge_page: "http://308628.m.weimob.com/Webnewmembercard/GetMember?pid=308628&wechatid=",
                home_page:"/vshop/index",
                my_address_page:"/payment/weixinpay/shopAddress?type=1"
            },
            data:{}
        }
    </script>
    <script src="../js/sea.js?v=20141101"></script>
    <script>
        (function(l){
            seajs.config({
//                base:"/vshop/Assets/",
                map: [
                    [ ".js", (l&&l[1]||"")+".js?v=20141101"]
                ]
            });
        })(location.href.match(/de(\-\d+)bug/));
    </script>
</head>
<body onselectstart="return true;" ondragstart="return false;">
<div data-role="container" class="container ordercreate2">
    <header data-role="header"></header>
    <section data-role="body" class="body" style="min-height: 591px;">
        <form id="form1" action="javascript:_alert('success');">
            <div class="section_address">
                <div id="wrap_address">
                    <script>
                        window.parent.postMessage({val:APP.data.address, method:"address"}, "*");
                    </script>
                </div>
            </div>
            <!---->
            <div class="section_detail">
                <div>
                    <header>
                        <p>
                            <label class="h8">购物清单</label>
                            <label class="label_amount_goods fr">共1件   ￥520.00</label>
                        </p>
                        <!--满减-->

                    </header>
                    <ul class="list_goods">

                        <li>
                            <a href="javascript:;" class="tbox">
                                <div>
                                        <span class="img_wrap">
                                            <img src="http://shopimg.weimob.com/308628/Goods/1502081255381328.jpg@0e_320w_320h_0c_0i_0o_90Q_1x.src" />
                                        </span>
                                </div>
                                <div>
                                    <p class="title">天蝎座-夜雾魅影</p>
                                    <p class="price">￥520.00</p>
                                    <p class="">L/数量1</p>
                                </div>
                            </a>
                        </li>

                    </ul>
                    <header class="header_transport">
                        <a href="javascript:;" >
                            <label class="h8">运送方式</label>
                            <label class="fr">免运费   ￥0.00</label>
                        </a>
                    </header>
                    <ul id="list_transport" class="list_transport"></ul>

                    <!--促销活动-->

                    <div class="mark_msg">
                        <input type="text" id="remark" placeholder="备注" maxlength="300" />
                    </div>
                    <header class="header_pay">
                        <a href="javascript:;">
                            <label class="h8">支付方式</label>
                        </a>
                    </header>
                    <ul id="pay_list" class="pay_list on">

                        <li>
                            <label class="tbox">
                                <div>
                                    <span class="pay_tenpay">&nbsp;</span>
                                </div>
                                <div>
                                    <p>财付通</p>
                                    <p>推荐财付通用户使用</p>
                                </div>
                                <div>
                                    <input type="radio" name="paytype" value='18161' class="radio" checked="checked" />
                                </div>
                            </label>
                        </li>

                        <li>
                            <label class="tbox">
                                <div>
                                    <span class="pay_alipay">&nbsp;</span>
                                </div>
                                <div>
                                    <p>支付宝</p>
                                    <p>推荐支付宝用户使用</p>
                                </div>
                                <div>
                                    <input type="radio" name="paytype" value='18162' class="radio" />
                                </div>
                            </label>
                        </li>

                        <li>
                            <label class="tbox">
                                <div>
                                    <span class="pay_unionpay">&nbsp;</span>
                                </div>
                                <div>
                                    <p>银行卡支付</p>
                                    <p>支持信用卡借记卡，无需开通网银</p>
                                </div>
                                <div>
                                    <input type="radio" name="paytype" value='18163' class="radio" />
                                </div>
                            </label>
                        </li>

                        <li>
                            <label class="tbox">
                                <div>
                                    <span class="pay_weipay">&nbsp;</span>
                                </div>
                                <div>
                                    <p>微信支付</p>
                                    <p>推荐已开通微信支付的用户使用</p>
                                </div>
                                <div>
                                    <input type="radio" name="paytype" value='22474' class="radio" />
                                </div>
                            </label>
                        </li>

                    </ul>
                </div>
            </div>
            <!---->
            <div>
                <div id="order_submit_1" class="section_price_and_pay align_center order_submit_1">
                    <p>总共支付   <span class="label_amount_total">￥</span></p>
                    <p class="p_delivery_fee">（含运费￥）</p>
                    <p>

                            <span>
                                <a href="javascript:;" class="btn red" onclick="createOrder(1)">提交订单</a>
                            </span>

                    </p>
                </div>
            </div>
        </form>
        <!---->
    </section>
    <footer data-role="footer">


        <div data-role="copyright">

            <script type="text/javascript" src="http://stc.weimob.com/src/st/share_channel.js?v=111111"></script>
            <script>
                var isGoodsDetial=0;//是否详情页
                var APPShareLink = "http://308628.m.weimob.com/vshop/Order/CreateOrder?aid=308628";
                var APPShareDes = '无情趣不生活';
                var APPShareTitle = '夏娃的秘密';
                var APPShareimg = 'http://hs-net-shop-img.oss-cn-hangzhou.aliyuncs.com/308628/Group/1411011832384713.jpg';
                var APPShareTitleId = "";
                var APPShareDesId = "";
                var APPSharehidDesId = "";
                var APPShareimgId = "";

                var FriendShareLink = "http://308628.m.weimob.com/vshop/Order/CreateOrder?aid=308628";
                var FriendShareDes = '无情趣不生活';
                var FriendShareTitle = '夏娃的秘密';
                var FriendShareimg = 'http://hs-net-shop-img.oss-cn-hangzhou.aliyuncs.com/308628/Group/1411011832384713.jpg';
                var FriendShareDesId = '';
                var FriendShareTitleId = '';
                var FriendSharehidTitleId = '';
                var FriendShareimgId = '';

                var WeiboShareimg = 'http://hs-net-shop-img.oss-cn-hangzhou.aliyuncs.com/308628/Group/1411011832384713.jpg';
                var WeiboShareDes = '无情趣不生活';
                var WeiboShareimgId = "";
                var WeiboShareDesId = '';
                document.title = '夏娃的秘密';

                var ShareSDAgentId = -1;
                var ShareAgentId = -1;
                var ShareEmployeesId = -1;
                var ShareVKId = -1;

                document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
                    var imgs = $("img");
                    var img = "";
                    if (imgs && imgs.length > 0 && imgs[0]) {
                        img = $(imgs[0]).attr("src");
                    }
                    // 发送给好友
                    WeixinJSBridge.on('menu:share:appmessage', function (argv) {
                        var thisimg = APPShareimg;
                        if (thisimg == "" && APPShareimgId != "") {
                            thisimg = $("#" + APPShareimgId).val();
                        }
                        if (thisimg == "") {
                            thisimg = img;
                        }
                        var thislink = APPShareLink;
                        var thisTitle = APPShareTitle;
                        if (thisTitle == "" && APPShareTitleId != "") {
                            thisTitle = $("#" + APPShareTitleId).val();
                        }
                        var thisDes = APPShareDes;
                        if (thisDes == "" && APPShareDesId != "") {
                            thisDes = $("#" + APPShareDesId).val();
                        }
                        if (thisDes == "" && APPSharehidDesId != "") {
                            thisDes = $("#" + APPSharehidDesId).val();
                        }
                        if (thisDes == "") {
                            thisDes = thisTitle;
                        }
                        thislink = channelHandle(thislink, "f");
                        WeixinJSBridge.invoke('sendAppMessage', {
                            "img_url": thisimg,
                            "img_width": "640",
                            "img_height": "640",
                            "link": thislink,
                            "desc": (isGoodsDetial==1?("来自微信好店："+"夏娃的秘密"):thisDes),
                            "title": ((isGoodsDetial==0?"推荐一家好店：":"")+ thisTitle)

                        }, function (res) {
                            if ('send_app_msg:cancel' != res.err_msg) {
                                if (APP && APP.page && APP.page == "detail" && ShareVKId > 0) {
                                    var sdagentid = 0;
                                    if(ShareSDAgentId > 0){
                                        sdagentid = ShareSDAgentId;
                                    }
                                    var agentid = 0;
                                    if(ShareAgentId > 0){
                                        agentid = ShareAgentId;
                                    }
                                    ShareGoods(308628,APP.goodsId,sdagentid,agentid,ShareVKId);
                                }
                            }
                            _report('send_msg', res.err_msg);
                        })
                    });

                    // 分享到朋友圈
                    WeixinJSBridge.on('menu:share:timeline', function (argv) {
                        var thisimg = FriendShareimg;
                        if (thisimg == "") {
                            thisimg = $("#" + FriendShareimgId).val();
                        }
                        if (thisimg == "") {
                            thisimg = img;
                        }
                        var thislink = FriendShareLink;
                        var thisTitle = FriendShareTitle;
                        if (thisTitle == "" && FriendShareTitleId != "") {
                            thisTitle = $("#" + FriendShareTitleId).val();
                        }
                        if (thisTitle == "" && FriendSharehidTitleId != "") {
                            thisTitle = $("#" + FriendSharehidTitleId).val();
                        }
                        var thisDes = FriendShareDes;
                        if (thisDes == "" && FriendShareDesId != "") {
                            thisDes = $("#" + FriendShareDesId).val();
                        }
                        if (thisDes == "") {
                            thisDes = thisTitle;
                        }
                        thislink = channelHandle(thislink, "fc");
                        WeixinJSBridge.invoke('shareTimeline', {
                            "img_url": thisimg,
                            "img_width": "640",
                            "img_height": "640",
                            "link": thislink,
                            "desc": (isGoodsDetial==1?"推荐一家好店："+"夏娃的秘密":thisTitle ),
                            "title":((isGoodsDetial==0?"推荐一家好店：":"")+ thisTitle)
                        }, function (res) {
                            if ('share_timeline:cancel' != res.err_msg) {
                                //如果用户没有取消
                                if (APP && APP.page && APP.page == "detail" && ShareVKId > 0) {
                                    var sdagentid = 0;
                                    if(ShareSDAgentId > 0){
                                        sdagentid = ShareSDAgentId;
                                    }
                                    var agentid = 0;
                                    if(ShareAgentId > 0){
                                        agentid = ShareAgentId;
                                    }
                                    ShareGoods(308628,APP.goodsId,sdagentid,agentid,ShareVKId);
                                }
                            }
                            _report('timeline', res.err_msg);
                        });
                    });

                    // 分享到微博
                    WeixinJSBridge.on('menu:share:weibo', function (argv) {
                        var thisimg = WeiboShareimg;
                        if (thisimg == "" && WeiboShareimgId != "") {
                            thisimg = $("#" + WeiboShareimgId).val();
                        }
                        if (thisimg == "") {
                            thisimg = img;
                        }
                        var thisDes = WeiboShareDes;
                        if (thisDes == "" && WeiboShareDesId != "") {
                            thisDes = $("#" + WeiboShareDesId).val();
                        }
                        WeixinJSBridge.invoke('shareWeibo', {
                            "content": thisDes,
                            "url": thisimg
                        }, function (res) {
                            if ('share_weibo:cancel' != res.err_msg) {
                                //weimobAfterShare("", window.shareData.weiboLink, 'weibo');
                            }
                            _report('weibo', res.err_msg);
                        });
                    });
                }, false);

                function ShareGoods(AId, goodsId, sdagentid, agentid, VKId){
                    $.ajax({
                        type: "POST",
                        url: "/vshop/Ajax/CopyRightAjax/Share",
                        data: {
                            aid:AId,
                            gid:goodsId,
                            sdagentid:sdagentid,
                            agentid:agentid,
                            vkid:VKId
                        },
                        async: true,
                        success: function (res) {

                        }, dataType: "json"
                    });
                }

            </script>

            <script type="text/javascript">
                setCookie("stat_pid", "308628");
                setCookie("stat_bid", "479772");
                try {
                    if (APP.openid || openid) {
                        setCookie("stat_openid", APP.openid || openid);
                        setCookie("stat_webtype", stat_webtype);
                    }

                }
                catch (e) { }
                setCookie("stat_webtype", stat_webtype);
                setCookie("stat_module", "vshop");
                function setCookie(name, value) {
                    var Days = 30;
                    var exp = new Date();
                    exp.setTime(exp.getTime() + Days * 24 * 60 * 60 * 1000);
                    document.cookie = name + "=" + escape(value) + ";expires=" + exp.toGMTString()+";path=/";
                }
            </script>

        </div>

    </footer>
    <div data-widget="tools" data-tools="tools_widget" id="tools_widget" class="tools_widget">
        <div class="widget_wrap">
            <ul class="tools_widget_wrap">
                <li><a href="javascript:;" id="tools_widget_goTop" class="tools_widget_goTop hidden">顶部</a>					</li>
                <li id="tools_kfli" style="display: none;"><a href="javascript:;" id="tolls_widget_message" class="tolls_widget_message">客服</a>					</li>
            </ul>
        </div>
    </div>
</div>


</body>
<script>
    //
    seajs.use("js_cmd/ordercreate2.js", function(core){
        var cache_curAddr = sessionStorage.getItem("cache_curAddr");
        //选中地址返回
        if(cache_curAddr){
            window.scrollTo(0,0);
            //clear cache_curAddr
            sessionStorage.removeItem("cache_curAddr");
            cache_curAddr = JSON.parse(cache_curAddr);
            var temp = new core.AppData();
            var cache_orderCreate = JSON.parse(sessionStorage.getItem("cache_orderCreate") );
            //clear cache_orderCreate
            sessionStorage.removeItem("cache_orderCreate");
            for(var kk in cache_orderCreate.APP_data){
                APP.data[kk] = cache_orderCreate.APP_data[kk];
            }
            for(k in cache_orderCreate.data){
                temp[k] = cache_orderCreate.data[k];
            }
            APP.data.address = cache_curAddr;
            $(function(){
                var $form1 = $("#form1");
                $form1[0].remark = cache_orderCreate.remark.value;
            });
            window.data = temp;
        }else{
            var cache_orderCreate = sessionStorage.getItem("cache_orderCreate");
            //未选择地址返回
            if(cache_orderCreate){
                window.scrollTo(0,0);
                cache_orderCreate = JSON.parse(cache_orderCreate );
                //clear cache_orderCreate
                var temp = new core.AppData();
                sessionStorage.removeItem("cache_orderCreate");
                for(var kk in cache_orderCreate.APP_data){
                    APP.data[kk] = cache_orderCreate.APP_data[kk];
                }
                for(k in cache_orderCreate.data){
                    temp[k] = cache_orderCreate.data[k];
                }
                $(function(){
                    var $form1 = $("#form1");
                    $form1[0].remark = cache_orderCreate.remark.value;
                });
                window.data = temp;
            }else{
                //页面初始化
                APP.data.address = null|| {address_id:0};
                //当前地址的可用运输方式
                APP.data.transport = {
                    index: 0,
                    list: [

                        { Name: "免运费 ", Id: "0", Fee: 0 }


                    ]
                }

                //<Type> 101:减 102:折扣 103:包邮
                APP.data.activitys = [];

                APP.data.paytypes = [{"Id":"18161","Name":"财付通","pay_type":"tenpay","IsWMPay":"1","pay_type_css":"pay_tenpay","orderBy":0,"Description":"推荐财付通用户使用"},{"Id":"18162","Name":"支付宝","pay_type":"alipay","IsWMPay":"1","pay_type_css":"pay_alipay","orderBy":0,"Description":"推荐支付宝用户使用"},{"Id":"18163","Name":"银行卡支付","pay_type":"chinapay","IsWMPay":"1","pay_type_css":"pay_unionpay","orderBy":0,"Description":"支持信用卡借记卡，无需开通网银"},{"Id":"22474","Name":"微信支付","pay_type":"newweipay","IsWMPay":"1","pay_type_css":"pay_weipay","orderBy":0,"Description":"推荐已开通微信支付的用户使用"}];

                window.data =(function(){
                    var temp=new core.AppData();
                    temp.businessSet={"Id":14310,"BId":479772,"AId":308628,"BusinessCategoryId":24,"Name":"夏娃的秘密","logo":"http://hs-net-shop-img.oss-cn-hangzhou.aliyuncs.com/308628/Group/1411011832384713.jpg","copyright":"夏娃的秘密官方商城","priceType":"1","phone":"021-65219708","address":"上海普陀区真南路1226弄康建商务广场9号楼402A","logistics":"H4sIAAAAAAAEAOy9B2AcSZYlJi9tynt/SvVK1+B0oQiAYBMk2JBAEOzBiM3mkuwdaUcjKasqgcplVmVdZhZAzO2dvPfee++999577733ujudTif33/8/XGZkAWz2zkrayZ4hgKrIHz9+fB8/Iv6F/+Cf/K//qb8s/Vv+3n/6f/97/4f/JwAA//9zErg/DQAAAA==","isFansorder":false,"notPayCloseTime":0,"AutoConfirmDelivery":0,"IsOrderQuery":true,"IsLogistics":true,"NotPayWarnTime":0,"NotPayWarnContent":"","ConfirmWarnTime":0,"ConfirmWarnContent":"","IsCoupon":true,"IsVipPoint":true,"VipPoints":100,"ChoiceType":1,"IsCrowdfundingStart":false,"IsStartAndPrioriShow":false,"IsHidePay":false,"CrowdfundingType":0,"CrowdfundingTitle":"","CustomLogoImgUrl":"http://hs-net-shop-img.oss-cn-hangzhou.aliyuncs.com/308628/Group/1411011830315913.png","IsNotShowCustomImg":false,"IsDistribution":false,"DistributtionCreateTime":"1970-01-01T00:00:00","IsGuide":false,"IsPushGuide":false,"PushContent":null,"IsApplyGuide":false,"ApplyContent":null,"GuideURL":null,"IsOpenOrCloseGuide":false,"WeiKeCondition":0.00,"WeiKeHeadLogo":null,"IsWeiKeGeneralze":false,"PerBillOfPoints":0,"PerBillOfRedPackage":50,"IsRedPackage":true,"HotValue":0};
                    temp.address=null;
                    temp.member={"Id":0,"Name":null,"HeadUrl":null,"Grade":null,"Points":0,"Balance":0.0,"Coupons":[],"Discount":100.0,"Rate":0.0,"IsVipPoint":false,"IsCoupon":false};

                    temp.TotalRedPackageAmount=0.00;

                    temp.delivery={"Id":0,"Name":"免运费","Fee":0.0,"ComCode":null};
                    temp.list=[{"ProductId":462132,"GoodsId":166088,"Name":"天蝎座-夜雾魅影","ImageUrl":"http://shopimg.weimob.com/308628/Goods/1502081255381328.jpg@0e_320w_320h_0c_0i_0o_90Q_1x.src","Description":"L","Price":520.00,"Count":1,"Remaining":50,"MemberPrice":520.00,"IsMemberPrice":true}];

                    if(temp.member.Coupons && temp.member.Coupons.length){
                        temp.coupon = temp.member.Coupons[0];
                    }
                    if(APP.data.address){
                        temp.address = APP.data.address;
                    }
                    if(APP.data.paytypes && APP.data.paytypes.length){
                        temp.payment = APP.data.paytypes[0];
                    }
                    if(APP.data.transport){
                        temp.delivery = APP.data.transport.list[APP.data.transport.index]||[{Name:"免运费 ", Id:"0", Fee:0}];
                    }
                    if(APP.data.activitys&&APP.data.activitys.length){
                        temp.activity = APP.data.activitys[0];
                    }
                    if(temp.member && temp.member.Points && temp.member.Points>0){
                        temp.points = 0;
                    }
                    if(temp.TotalRedPackageAmount){
                        temp.redPackageAmount = 0;
                    }
                    return temp;
                })();
            }
        }//end else
        //显示支付金额
        var flags = [0, 0, 0];
        data.showAmount=function(totalAmount,fee,pointsAmount,points){
            totalAmount = data.payAmount;//bug fix
            if(totalAmount<0 && data.member){
                //减积分(已使用，并且超额使用)
                if(!flags[0] && data.points>0){
                    flags[0] = 1;
                    var d_points = data.points, _points = Math.floor(-totalAmount*data.businessSet.VipPoints);
                    data.points -= Math.min(d_points, _points);
                    return;
                }
                //再减红包
                if(!flags[0] && data.redPackageAmount>0){
                    flags[1] = 1;
                    var d_redPackageAmount = data.redPackageAmount;
                    data.redPackageAmount -= Math.min(d_redPackageAmount, -totalAmount);
                    return;
                }
                //再减券
                if(!flags[0] && data.coupon && data.coupon.Id){
                    flags[2] = 1;
                    data.coupon = {};
                    return;
                }
                totalAmount = 0;
                flags = [0, 0, 0];
            }


            var tempAmount=data.member.Points/(data.businessSet.VipPoints==0?100:(data.businessSet.VipPoints||100));
            $(".label_amount_total").html("￥"+totalAmount.toFixed(2));
            $(".p_delivery_fee").html("（含运费￥"+fee.toFixed(2)+"）");
            if(data.member.Points>0&&pointsAmount==0)
            {
                if(totalAmount>tempAmount){
                    $(".pointsAmount").html(tempAmount.toFixed(2));
                }
                else{
                    $(".pointsAmount").html(totalAmount.toFixed(2));
                }
            }
            else
                $(".pointsAmount").html(parseFloat(pointsAmount).toFixed(2));
            if(points!=0){
                $(".points").html(points);
            }
            else{
                if(totalAmount>tempAmount){
                    $(".points").html(data.member.Points);
                }
                else
                {
                    $(".points").html((totalAmount*(data.businessSet.VipPoints==0?100:(data.businessSet.VipPoints||100))).toFixed());
                }
            }
            data.payAmountEqualsZero(totalAmount <= 0);
        }
        //显示支付方式列表
        data.payAmountEqualsZero=function(hide){
            if(hide){
                $(".header_pay").hide();
                $(".pay_list").hide();
                //隐藏支付方式:TODO
                //data.payment=null;
            }
            else{
                //显示支付方式，选择默认支付方式:TODO
                $(".header_pay").show();
                $(".pay_list").show();
                //data.payment=data.prePayment;
            }
        }
        //地址改变
        data.listChange = data.addressChange = function(address,list, fn){
            var that=this;
            var l = loading();
            $.ajax({
                type:"POST",
                url:"/vshop/Ajax/FreightAjax/GetDeliveryTypeList",
                data:{
                    provinceId: address.province_id,
                    zoneId: address.zone_id,
                    cityId:address.city_id,
                    list:JSON.stringify(list)
                },
                async:false,
                success:function(res){
                    l.destroy();
                    if(res.Status==0){
                        APP.data.transport={index:0,list:res.Data||[{Name:"暂无快递  ", Id:"0", Fee:"0.00"}]};
                        window.data.delivery=APP.data.transport.list[0];
                        fn&&fn();
                    }
                    else{
                        alert("获取运费模板失败");
                    }
                },
                dataType:"json"
            });
        }
        //
        core.$(function(){
            data.address = APP.data.address||{};
            if(APP.data.activitys&&APP.data.activitys.length){
                data.activity = APP.data.activitys[0];
            }
            data.showAmount(data.payAmount, data.deliveryFee, data.pointsAmount, data.points);
            //
            sessionStorage.removeItem("cache_curAddr");
            sessionStorage.removeItem("cache_orderCreate");
        });
    });//end use
    document.title = "订单提交";
</script>
</html>
